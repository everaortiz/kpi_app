import pandas as pd
import requests
import json
import datetime 
import arrow


def get_dataset_ids(group_id, client_id, username, password):
        """

        Returns from a group_id - workspace, all the dataset ids.
        
        """
        
        url = "https://login.windows.net/common/oauth2/token"
        body = {'client_id': client_id, 'grant_type': 'password',
            'resource': 'https://analysis.windows.net/powerbi/api', 'username': username,
            'password': password}

        r = requests.post(url, data=body)
        token_type = eval(r.text)['token_type']
        access_token = eval(r.text)['access_token']
    
        url2 = 'https://api.powerbi.com/v1.0/myorg/groups/' + group_id + '/datasets/'
        header = {'Authorization': token_type + ' ' + access_token}
        r2 = requests.get(url2, headers=header, timeout=1.5) 
        txt=r2.text
        json.loads(txt)
        a=json.loads(txt)
        
        df = pd.DataFrame(columns=['pbi_report', 'group_id', 'dataset_id', 'workspace'])
        k = 0
        w = 1
        for thing in a['value']:
            w = w
            k = k
            b = str(a['value'][k]['id'])
            c = str(a['value'][k]['name'])
        
            df_new = pd.DataFrame({"pbi_report":[c], "group_id":[group_id], "dataset_id":[b], "workspace":workspace})
            df= df.append(df_new, ignore_index=True)
            rows = df.shape[0]
                        
            if  w <= rows:
                w = w+1
                k = k+1
            else: 
                break
            
        return df

def get_last_refresh_time_dataset(group_id, dataset_id, client_id, username, password):
        """

        Obtains the last refresh time from a dataset_id.
        
        """
        
        url = "https://login.windows.net/common/oauth2/token"
        body = {'client_id': client_id, 'grant_type': 'password',
            'resource': 'https://analysis.windows.net/powerbi/api', 'username': username,
            'password': password}

        r = requests.post(url, data=body)
        token_type = eval(r.text)['token_type']
        access_token = eval(r.text)['access_token']
    
        url2 = 'https://api.powerbi.com/v1.0/myorg/groups/' + group_id + '/datasets/' + dataset_id + '/refreshes?$top=1'
        header = {'Authorization': token_type + ' ' + access_token}
        r2 = requests.get(url2, headers=header, timeout=1.5) 
        txt=r2.text
        json.loads(txt)
        a=json.loads(txt)
        b=a['value'][0]['endTime']
    
        date_time_string = datetime.datetime.strptime(b,'%Y-%m-%dT%H:%M:%S.%fZ').strftime('%Y-%m-%d %H:%M:%S.%f')
        date_time_obj = datetime.datetime.strptime(date_time_string, '%Y-%m-%d %H:%M:%S.%f')
        dt_timezone = arrow.get(date_time_obj).to('Europe/Madrid')
        dt_timezone = dt_timezone.format('YYYY-MM-DD HH:mm:ss')
    
        return dt_timezone

def refresh_dataset(group_id, dataset_id, client_id, username, password):
    """
    
    Refreshes the Power BI dataset from a dataset_id, group_id,
    client_id, username and password.
    
    """
    
    url = "https://login.windows.net/common/oauth2/token"
    body = {'client_id': client_id, 'grant_type': 'password',
            'resource': 'https://analysis.windows.net/powerbi/api', 'username': username,
            'password': password}

    r = requests.post(url, data=body)
    token_type = eval(r.text)['token_type']
    access_token = eval(r.text)['access_token']

    url2 = ' https://api.powerbi.com/v1.0/myorg/groups/' + group_id + '/datasets/' + dataset_id + '/refreshes'
    header = {'Authorization': token_type + ' ' + access_token}
    r2 = requests.post(url2, headers=header)

    print(r2.status_code)

    if r2.status_code == 202:
        print('Refresh OK')
    else:
        print('Error')

